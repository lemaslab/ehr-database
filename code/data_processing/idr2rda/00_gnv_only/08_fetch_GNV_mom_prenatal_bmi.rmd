---
title: "fetch_data: prenatal-bmi (October 2025; Gainesville)"
author: "Dominick Lemas"
date: "10/24/2025"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---

```{r, include=FALSE, echo=FALSE}

# **************************************************************************** #
#                           Project Overview                                   #
# **************************************************************************** #

# Author:            Dominick Lemas
# Start Date:        November 06, 2024
# Last Modified:     October 24, 2025
# IRB:               UFHealth Early Life Exposures and Pediatric Outcomes (IRB201601899)

# R Version:         4.0.3 (2020-10-10)
# RStudio Version:   1.3.1073

# **************************************************************************** #
#                           Project Description                                #
# **************************************************************************** #

# Purpose:
# This script aims to access flat files stored on the shared drive, 
# pull, format, and clean the data for downstream analysis.

# Requirements:
# - VPN must be active for remote access to the shared drive.
# - R packages: tidyverse, lubridate.

# Objective:
# Export cleaned prenatal BMI data as an .rda file for subsequent analyses.

# Plan:
# 1. Access flat files stored on the shared drive.
# 2. Load the data into R.
# 3. Perform data formatting and cleaning.
# 4. Save the cleaned data as an .rda file.

# Notes:
# - Ensure that you have the necessary permissions to access the shared drive.
# - Review the data for inconsistencies before saving the final .rda file.

# **************************************************************************** #
#                           Libraries                                          #
# **************************************************************************** #

library(tidyverse)   # Comprehensive collection of data manipulation and visualization tools
library(lubridate)   # Functions to work with date and time objects

# directory
 working_dir="C:/Users/djlemas/Documents/GitHub/ehr-database"

# End of Script
##############################################################################
```

```{r, include=FALSE, message=FALSE, warning=FALSE}

# ----------------------------------------------------------------------- #
# Step 1: Pull Data
# ----------------------------------------------------------------------- #

# Dataset Summary:
# - Rows:              182,318      
# - Columns:           4 
# - Unique Mom IDs:    16,898
# - Unique Infant IDs: NA
# - Repeat:            1
# - ICD9/10 Codes:     NA

# Data Directory:
# -----------------
# The dataset file and its directory path.
data_file_name <- "mom_BMI_prenatals.csv"
data_dir <- paste0("V:/FACULTY/DJLEMAS/EHR_Data/raw/READ_ONLY_DATASETS/10year_data/2021/dataset_09_2021/mom_data/")
data_import_path <- paste0(data_dir, data_file_name)

prenatal_bmi_mom_tmp <- read_csv(data_import_path, col_types = cols()) %>%
  rename(
    part_id_mom_tmp = `Deidentified_mom_ID`, 
    encounter_type = `Encounter Type`,
    prenatal_bmi_kgm2 = `Last Stamped BMI on encounter`, 
    prenatal_bmi_date = `Last Stamped BMI on encounter datetime`
  ) %>%
  mutate(
    prenatal_bmi_date = ymd_hms(prenatal_bmi_date),
    part_id_mom = paste0("mom-", part_id_mom_tmp)
  ) %>%
  select(-part_id_mom_tmp) %>% 
  select(part_id_mom, everything()) %>%
  mutate(part_id_mom=paste0("GNV-",part_id_mom))

# End of Script
##############################################################################
```

```{r, include=FALSE, message=FALSE, warning=FALSE}

# ----------------------------------------------------------------------- #
# Step 2: load mom-baby link data
# ----------------------------------------------------------------------- #
# load("V:/FACULTY/DJLEMAS/EHR_Data/processed/10year_data/mom_baby_link_ALL_20251023.rda") 
data_file_name <- "mom_baby_link_ALL_20251023.rda"
data_dir <- paste0(working_dir,"/data/ready/")
data_import_path <- paste0(data_dir, data_file_name)
load(data_import_path)

# ----------------------------------------------------------------------- #
# Step 3: merge data with mom-baby link and compute derived variables
# ----------------------------------------------------------------------- #
prenatal_bmi_mom_tmp2 <- full_join(prenatal_bmi_mom_tmp, mom_baby_link_ALL, by = "part_id_mom") %>%
  
  # Task 2.1: Retain only records with valid prenatal BMI dates
  drop_na(prenatal_bmi_date) %>%
  
  # Task 2.2: Format Date Fields
  # Convert the datetime columns to Date format for consistent processing
  mutate(
    prenatal_bmi_date = as_date(prenatal_bmi_date),
    part_dob_infant = as_date(part_dob_infant)
  ) %>%
  
  # Task 2.3: Calculate Derived Variables
  # Compute the interval (in days) between prenatal BMI measurement and infant's date of birth
  mutate(
    dx2delivery_days = as.numeric(prenatal_bmi_date - part_dob_infant)
  ) 

# rename
GNV_prenatal_bmi_mom_10_2025=prenatal_bmi_mom_tmp2

```


```{r, message=FALSE}
# ----------------------------------------------------------------------- #
# Step 4: export to sharedrive
# ----------------------------------------------------------------------- #

## EXPORT to Sharedrive
file_name="GNV_prenatal_bmi_mom"
timestamp <- format(Sys.time(), "_%Y%m%d")
file_name_path=paste0(file_name,timestamp,".rda")

# Define export directories
shared_dir <- "V:/FACULTY/DJLEMAS/EHR_Data/processed/READ_ONLY_DATASETS/10year_data/GNV/"
local_dir  <- file.path(working_dir, "data", "ready")

# Ensure local directory exists
if (!dir.exists(local_dir)) dir.create(local_dir, recursive = TRUE)

# Construct full export paths
shared_path <- file.path(shared_dir, file_name_path)
local_path  <- file.path(local_dir, file_name_path)

# Save to shared drive
save(GNV_prenatal_bmi_mom_10_2025, file = shared_path)

# Save locally
save(GNV_prenatal_bmi_mom_10_2025, file = local_path)

message("Data successfully exported to:")
message(" - Shared drive: ", shared_path)
message(" - Local folder: ", local_path)

```
